name: DRC Files
on:
  push:
    paths:
      - '**.kicad_sch'
      - '**.kicad_pcb'

  pull_request:
    paths:
      - '**.kicad_sch'
      - '**.kicad_pcb'
      
  workflow_dispatch:

jobs:
  drc-files:
    name: DRC Everything
    runs-on: ubuntu-latest
    container: setsoft/kicad_auto:dev_k6
      
    steps:

    - name: Generate Short SHA Environment Variable
      run: echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV
      
    - name: Update system repositories, Install Required Libraries and Initialize git-lfs
      run: |
        apt update
        apt -y install git git-lfs zip librsvg2-bin imagemagick
        git lfs install
    - name: Checkout Repository
      uses: actions/checkout@v2
      with:
        lfs: true
        
    - name: DRC PB_16v1 Files
      run: |
        cd PB_16v1
        rm -rf PB_16v1/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e PB_16.kicad_sch -b PB_16.kicad_pcb -d PB_16v1

    - name: DRC PB_16v2_SMD Files
      run: |
        cd PB_16v2_SMD
        rm -rf PB_16v2_SMD/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e PB_16.kicad_sch -b PB_16.kicad_pcb -d PB_16v2_SMD

    - name: DRC BBB_16 Files
      run: |
        cd BBB_16
        rm -rf BBB_16/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e BBB_16.kicad_sch -b BBB_16.kicad_pcb -d BBB_16

    - name: DRC BBB_16_SMD Files
      run: |
        cd BBB_16_SMD
        rm -rf BBB_16_SMD/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e BBB_16.kicad_sch -b BBB_16.kicad_pcb -d BBB_16_SMD

    - name: DRC BBB_16_Expansion Files
      run: |
        cd BBB_16_Expansion
        rm -rf BBB_16_Expansion/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e BBB_16_Expansion.kicad_sch -b BBB_16_Expansion.kicad_pcb -d BBB_16_Expansion

    - name: DRC BBB_16_Flex Files
      run: |
        cd BBB_16_Flex
        rm -rf BBB_16_Flex/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e BBB_16_Flex.kicad_sch -b BBB_16_Flex.kicad_pcb -d BBB_16_Flex

    - name: DRC Receiver_Out Files
      run: |
        cd Receiver_Out
        rm -rf Receiver_Out/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e Receiver_Out.kicad_sch -b Receiver_Out.kicad_pcb -d Receiver_Out

    - name: DRC Receiver_Out_SMD Files
      run: |
        cd Receiver_Out_SMD
        rm -rf Receiver_Out_SMD/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e Receiver_Out.kicad_sch -b Receiver_Out.kicad_pcb -d Receiver_Out_SMD

    - name: DRC Input_Adapter Files
      run: |
        cd Input_Adapter
        rm -rf Input_Adapter/
        kibot -c ../.github/workflows/scripts/kibot/drc.config.kibot.yaml -e Input_Adapter.kicad_sch -b Input_Adapter.kicad_pcb -d Input_Adapter

    - name: Upload Export Files as Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: output
        path: |
          PB_16v1/PB_16v1/**
          PB_16v2_SMD/PB_16v2_SMD/**
          BBB_16/BBB_16/**
          BBB_16_SMD/BBB_16_SMD/**
          BBB_16_Expansion/BBB_16_Expansion/**
          BBB_16_Flex/BBB_16_Flex/**
          Receiver_Out/Receiver_Out/**
          Receiver_Out_SMD/Receiver_Out_SMD/**
          Input_Adapter/Input_Adapter/**
        if-no-files-found: error
        retention-days: 60

